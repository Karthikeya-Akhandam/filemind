name: Generate Release Data

on:
  workflow_run:
    workflows: ["Build and Release"]
    types: [completed]
  workflow_dispatch: # allow manual re-runs

permissions:
  contents: write # To commit the generated releases.json

jobs:
  generate_release_json:
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: main
          token: ${{ secrets.RELEASE_PAT }}

      - name: Fetch and process release data
        id: fetch_data
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Fetch all releases (including pre-releases)
          RELEASES_JSON=$(gh api repos/${{ github.repository }}/releases --paginate)

          # Use jq to parse and format data for the releases.json structure
          # Filter for actual release assets (executables, not source code zips/tar.gz)
          # Note: Adjust asset filtering if names change from 'filemind-vX.Y.Z-platform.ext'
          GENERATED_JSON=$(echo "$RELEASES_JSON" | jq '[
            .[] | {
              tag_name: .tag_name,
              name: .name,
              prerelease: .prerelease,
              html_url: .html_url,
              published_at: .published_at,
              assets: [
                .assets[] | {
                  name: .name,
                  browser_download_url: .browser_download_url
                } | select(.name | test("filemind-v.*-(linux-amd64|macos-amd64|windows-amd64\\.exe)$"))
              ]
            }
          ]')

          echo "$GENERATED_JSON" > docs/releases.json

      - name: Commit releases.json
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add docs/releases.json
          git commit -m "docs: Auto-generate releases.json" || echo "No changes to commit"
          git pull --rebase
          git push
